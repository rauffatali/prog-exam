# Bank Management Tools

**Purpose:** Command-line tools for managing encrypted question banks in the Offline Python Exam System.

---

## Tools Overview

| Tool | Purpose | Typical Usage |
|------|---------|---------------|
| `keygen.py` | Generate encryption keys | Once per exam group (optional - can use passwords) |
| `build_bank.py` | Encrypt plaintext banks | After authoring tasks (key file OR password) |
| `verify_bank.py` | Validate and test decrypt | During authoring + pre-deployment |
| `rotate_key.py` | Re-encrypt with new key/password | Post-exam (before reuse) |
| `config_helper.py` | Create/validate exam config | Before exam deployment (set parameters) |


---

## Installation

### Requirements
- Python 3.10+
- `cryptography` library

### Setup

**Windows:**
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install cryptography
```

**macOS / Linux:**
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install cryptography
```

---

## Tool Details

### 1. keygen.py

**Purpose:** Generate a new Fernet encryption key.

**Usage:**
```bash
python tools/keygen.py --out GROUP1.key
```

**Output:**
- Creates a `.key` file containing a 256-bit Fernet key (base64-encoded)
- Prints the key to console for verification

**Note:** Key files are optional. You can use passwords instead (see `build_bank.py --password`).

**Security Notes:**
- Store keys in password manager, never commit to Git
- Generate one key per exam group
- Rotate keys after each exam session

---

### 2. build_bank.py

**Purpose:** Encrypt a plaintext JSON question bank.

**Usage with key file:**
```bash
python tools/build_bank.py \
  --in bank_group1.json \
  --out banks/bank_group1.enc \
  --key-file GROUP1.key
```

**Usage with password:**
```bash
python tools/build_bank.py \
  --in bank_group1.json \
  --out banks/bank_group1.enc \
  --password
```
You'll be prompted to enter and confirm your password.

**Input:**
- Plaintext JSON file (must conform to schema in `banks/bank_schema.md`)
- Encryption key file (generated by `keygen.py`) OR password

**Output:**
- Encrypted `.enc` file (Fernet format)
- SHA256 checksum (for verification)
- Encryption method indicator (password-based or key file)

**Validation:**
- Validates JSON syntax before encrypting
- Shows task count per difficulty level
- Password must be at least 8 characters (12+ recommended)

**Security:**
- Passwords use PBKDF2-HMAC-SHA256 with 480,000 iterations
- Unique 16-byte salt per bank (prevents rainbow tables)

---

### 3. verify_bank.py

**Purpose:** Validate bank schema and test decryption.

**Usage:**

**Plaintext bank:**
```bash
python tools/verify_bank.py --bank bank_group1.json
```

**Encrypted bank (key file):**
```bash
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --key-file GROUP1.key
```

**Encrypted bank (password):**
```bash
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --password
```
You'll be prompted to enter the password.

**Verbose mode:**
```bash
python tools/verify_bank.py --bank bank_group1.json --verbose
```

**Auto-detection:** The tool automatically detects whether a bank was encrypted with a key file or password.

**Validations Performed:**
- Top-level structure (group, version, difficulties)
- 60 tasks (20 per difficulty)
- 15 test cases per task
- Required fields for each task
- I/O mode consistency
- Time/memory limits
- Checker function names

**Output:**
- List of errors (blocking)
- List of warnings (non-blocking)
- Summary statistics

**Exit Codes:**
- `0`: Validation passed
- `1`: Validation failed

---

### 4. rotate_key.py

**Purpose:** Re-encrypt a bank with a new key or password (for key rotation policy).

**Usage (key file to key file):**
```bash
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-key-file GROUP1.key \
  --new-key-file GROUP1_2026.key
```

**Usage (password to password):**
```bash
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-password \
  --new-password
```

**Usage (key file to password):**
```bash
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-key-file GROUP1.key \
  --new-password
```

**Usage (password to key file):**
```bash
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-password \
  --new-key-file GROUP1_2026.key
```

**Process:**
1. Decrypt bank with old key/password
2. Encrypt with new key/password
3. Write to output file (can overwrite input)
4. Print SHA256 checksums (before/after)

**Use Cases:**
- Post-exam key/password rotation
- Key compromise recovery
- Converting between password and key file methods
- Changing encryption keys/passwords for reused banks

**Security Notes:**
- For key files: Generate new key with `keygen.py` first
- Archive old key/password securely (for audit trail)
- Verify decryption with new key/password after rotation

---

### 5. config_helper.py

**Purpose:** Interactive tool to help teachers create and validate exam configuration files.

**Usage:**
```bash
python tools/config_helper.py
```

**Features:**
1. **Create new configuration** - Interactive prompts for all parameters
2. **Validate existing configuration** - Check config file for errors
3. **Show example configurations** - Display common config patterns
4. **Save to file** - Write configuration to `config.json`

**Interactive Example:**
```bash
python tools/config_helper.py

EXAM CONFIGURATION HELPER TOOL
Options:
  1. Create new configuration
  2. Validate existing configuration
  3. Show example configurations
  4. Exit

Enter your choice (1-4): 1

Total number of questions per student: 3

Now specify how many of each difficulty (must sum to 3):
  Easy questions: 1
  Medium questions: 1
  Hard questions: 1

Now specify the point value for each difficulty level:
  Points for each Easy question: 5
  Points for each Medium question: 5
  Points for each Hard question: 5

Calculated maximum points: 15.0
Is this correct? (y/n): y

Now specify exam parameters:
  Exam time limit in minutes (default: 180, -1 for unlimited): -1
  → Exam time set to unlimited
  Work directory postfix (default: TP_TEST): TP_TEST

Configuration created successfully!
{
  "total_questions": 3,
  "easy_count": 1,
  "medium_count": 1,
  "hard_count": 1,
  "easy_weight": 5.0,
  "medium_weight": 5.0,
  "hard_weight": 5.0,
  "max_points": 15.0,
  "exam_time_minutes": 180,
  "work_dir_postfix": "TP_TEST"
}

Save to config.json? (y/n): y

✓ Configuration saved to: config.json
```

**Validate Example:**
```bash
python tools/config_helper.py

Enter your choice (1-4): 2

Enter config file path (default: config.json): 

CONFIG VALIDATOR
Validating: config.json

Configuration:
  Total Questions: 3
  Easy:   1 × 5.0 pts = 5.0 pts
  Medium: 1 × 5.0 pts = 5.0 pts
  Hard:   1 × 5.0 pts = 5.0 pts
  Maximum Points: 15.0
  Exam Time: 180 minutes (use -1 for unlimited time)
  Work Directory Postfix: TP_TEST

✓ Configuration is VALID!
```

**Validations Performed:**
- Question counts sum to total_questions
- Point weights sum to max_points
- All values are non-negative
- Exam time is -1 (unlimited) or positive integer
- Work directory postfix is valid string
- JSON syntax is valid

**Output:**
- Creates/validates `config.json` in current directory
- Config file will be automatically loaded by exam system

**Note:** Place the `config.json` file in the same directory as the exam executable for deployment.

For detailed information about exam configuration, see: `../documentations/TEACHER_CONFIG_GUIDE.md`

---

## Common Workflows

### New Bank Creation (Key File Method)

```bash
# 1. Author plaintext bank (manual)
#    → Create bank_group1.json following schema

# 2. Validate schema
python tools/verify_bank.py --bank bank_group1.json --verbose

# 3. Generate key
python tools/keygen.py --out GROUP1.key

# 4. Encrypt bank
python tools/build_bank.py \
  --in bank_group1.json \
  --out banks/bank_group1.enc \
  --key-file GROUP1.key

# 5. Verify encrypted bank
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --key-file GROUP1.key
```

### New Bank Creation (Password Method)

```bash
# 1. Author plaintext bank (manual)
#    → Create bank_group1.json following schema

# 2. Validate schema
python tools/verify_bank.py --bank bank_group1.json --verbose

# 3. Encrypt bank with password
python tools/build_bank.py \
  --in bank_group1.json \
  --out banks/bank_group1.enc \
  --password
# Enter password when prompted

# 4. Verify encrypted bank
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --password
# Enter password when prompted
```

### Pre-Exam Verification

```bash
# Test decryption on clean machine
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --key-file GROUP1.key

# Expected: [OK] Bank validation PASSED
```

### Post-Exam Key Rotation (Key File)

```bash
# 1. Generate new key
python tools/keygen.py --out GROUP1_2026.key

# 2. Rotate key
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-key-file GROUP1.key \
  --new-key-file GROUP1_2026.key

# 3. Verify with new key
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --key-file GROUP1_2026.key

# 4. Archive old key securely
```

### Post-Exam Password Rotation

```bash
# 1. Change password
python tools/rotate_key.py \
  --in banks/bank_group1.enc \
  --out banks/bank_group1.enc \
  --old-password \
  --new-password
# Enter old and new passwords when prompted

# 2. Verify with new password
python tools/verify_bank.py \
  --bank banks/bank_group1.enc \
  --password
# Enter new password when prompted
```

---

## Error Handling

### "ModuleNotFoundError: No module named 'cryptography'"

**Solution:** Install cryptography in virtual environment
```bash
pip install cryptography
```

### "[ERROR] Decryption failed: Invalid key/password or corrupted file"

**Causes:**
- Wrong key file or password
- Corrupted bank file
- Corrupted key file
- Using --password flag on key-file encrypted bank (or vice versa)

**Solution:**
1. Verify correct key/password is being used
2. Check file sizes (key ~44 bytes)
3. Try the other decryption method (--password vs --key-file)
4. Re-encrypt from plaintext source if needed

### "[ERROR] This bank was encrypted with a password. Use --password flag."

**Cause:** Trying to decrypt password-encrypted bank with --key-file

**Solution:** Use --password flag instead:
```bash
python tools/verify_bank.py --bank banks/bank_group1.enc --password
```

### "[ERROR] This bank was encrypted with a key file. Use --key-file."

**Cause:** Trying to decrypt key-file encrypted bank with --password

**Solution:** Use --key-file flag instead:
```bash
python tools/verify_bank.py --bank banks/bank_group1.enc --key-file GROUP1.key
```

### "[ERROR] Invalid JSON: ..."

**Cause:** JSON syntax error in plaintext bank

**Solution:**
1. Validate JSON with online validator or `jq`
2. Fix syntax errors
3. Re-run validation

---

## File Formats

### Key File (.key)
- Format: Raw bytes (base64-encoded Fernet key)
- Size: 44 bytes
- Encoding: Base64
- Example: `EE2GANWkqTJZZ85xQCNdkD8LtqvYk2CY9vHUz0akSfs=`

### Plaintext Bank (.json)
- Format: JSON
- Schema: See `banks/bank_schema.md`
- Typical size: 30-50 KB (60 tasks)

### Encrypted Bank (.enc)
- Format: Fernet token (binary)
- Contains: Encrypted JSON + HMAC + timestamp
- Typical size: 40-70 KB (includes encryption overhead)
- Password-based banks: +20 bytes (4-byte `SALT` marker + 16-byte salt)

---

## Security Best Practices

1. **Never commit keys to Git**
   - Add `*.key` to `.gitignore`
   - Use password manager for storage

2. **Never distribute plaintext banks**
   - Keep `.json` files in private repository
   - Only deploy `.enc` files to exam machines

3. **Rotate keys/passwords after each session**
   - Use `rotate_key.py` workflow
   - Archive old keys/passwords securely

4. **Use strong passwords (if using password method)**
   - Minimum 8 characters enforced (12+ recommended)
   - Mix uppercase, lowercase, numbers, symbols
   - Example: `ExamG1-Nov2025!`
   - Store in password manager

5. **Verify before deploying**
   - Always run `verify_bank.py` on encrypted banks
   - Test decryption on clean machine

6. **Document encryption method**
   - Track which key/password encrypts which bank
   - Log key/password rotation events
   - Remember: Banks encrypted with passwords cannot be recovered if password is lost!

---

## Development Notes

### Dependencies
- `cryptography.fernet.Fernet` — Symmetric encryption
- `cryptography.hazmat.primitives.kdf.pbkdf2.PBKDF2HMAC` — Password-based key derivation
- `argparse` — CLI argument parsing
- `json` — Bank parsing
- `hashlib` — SHA256 checksums
- `pathlib` — Cross-platform paths
- `getpass` — Secure password input

### Error Handling
- All tools use try/except for graceful failures
- Exit codes: 0 (success), 1 (failure)
- Errors printed to stderr

### Output Format
- ASCII-compatible symbols for Windows console
- `[OK]` — Success
- `[ERROR]` — Failure
- `[!]` — Warning/Important

---

## Testing

### Smoke Test
See `../SMOKE_TEST_RESULTS.md` for complete test sequence.

**Quick test:**
```bash
# Generate test key
python tools/keygen.py --out TEST.key

# Create minimal test bank (1 task per difficulty)
# ... (see bank_schema.md for structure)

# Encrypt
python tools/build_bank.py --in test.json --out test.enc --key-file TEST.key

# Verify
python tools/verify_bank.py --bank test.enc --key-file TEST.key

# Expected: [OK] Bank validation PASSED
```

---

## Support

**Help Text:**
```bash
python tools/keygen.py --help
python tools/build_bank.py --help
python tools/verify_bank.py --help
python tools/rotate_key.py --help
```

---

**Tools Version:** 0.1.2  
**Last Updated:** 2025-11-01  
**Status:** Production Ready

---

## Password vs Key File: Quick Comparison

| Feature | Password | Key File |
|---------|----------|----------|
| **Ease of Use** | ✅ Easier (just remember) | Requires file management |
| **Security** | ✅ High (if strong password) | ✅ High |
| **Distribution** | Communicate password | Distribute file |
| **Recovery** | ❌ None if forgotten | ✅ Can backup file |
| **Automation** | ❌ Difficult | ✅ Easy |
| **Overhead** | +20 bytes (salt) | None |

**Recommendation:** Use passwords for simpler workflows, key files for automation or if backup is critical.

